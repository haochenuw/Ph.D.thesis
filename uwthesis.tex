%  ========================================================================
%  Copyright (c) 1985-2014 The University of Washington
%
%  Licensed under the Apache License, Version 2.0 (the "License");
%  you may not use this file except in compliance with the License.
%  You may obtain a copy of the License at
%
%      http://www.apache.org/licenses/LICENSE-2.0
%
%  Unless required by applicable law or agreed to in writing, software
%  distributed under the License is distributed on an "AS IS" BASIS,
%  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
%  See the License for the specific language governing permissions and
%  limitations under the License.
%  ========================================================================
%

% Documentation for University of Washington thesis LaTeX document class
% by Jim Fox
% fox@washington.edu
%
%    Revised for version 2015/03/03 of uwthesis.cls
%
%    This document is contained in a single file ONLY because
%    I wanted to be able to distribute it easily.  A real thesis ought
%    to be contained on many files (e.g., one for each chapter, at least).
%
%    To help you identify the files and sections in this large file
%    I use the string '==========' to identify new files.
%
%    To help you ignore the unusual things I do with this sample document
%    I try to use the notation
%       
%    % --- sample stuff only -----
%    special stuff for my document, but you don't need it in your thesis
%    % --- end-of-sample-stuff ---


%    Printed in twoside style now that that's allowed
%
 
\documentclass [11pt, proquest] {uwthesis}[2015/03/03]

\usepackage{thesismacros}
\usepackage{algpseudocode}
\usepackage{algorithmicx}
\usepackage{algorithm}
\usepackage{url}
\renewcommand{\algorithmicrequire}{\textbf{Input:}}
\renewcommand{\algorithmicensure}{\textbf{Output:}}
\usepackage{amsmath,mathtools}

\usepackage[textwidth=50,textsize=tiny]{todonotes}
\setlength{\marginparwidth}{2cm}
\newcommand{\tinytodo}[2][]
{\todo[caption={#2}, #1]{\renewcommand{\baselinestretch}{0.5}\selectfont#2\par}}
\newcommand{\Katetodo}[1]{\tinytodo[color=green!20]{#1}}
\newcommand{\Haotodo}[1]{\tinytodo[color=red!20]{#1}}
\newcommand{\Kristintodo}[1]{\tinytodo[color=blue!20]{#1}}

\renewcommand{\algorithmicrequire}{{\bf Input:}}
\renewcommand{\algorithmicensure}{{\bf Output:}}


%
% The following line would print the thesis in a postscript font 

% \usepackage{natbib}
% \def\bibpreamble{\protect\addcontentsline{toc}{chapter}{Bibliography}}

\setcounter{tocdepth}{1}  % Print the chapter and sections to the toc
 

% ==========   Local defs and mods
%

% --- sample stuff only -----
% These format the sample code in this document


\usepackage{alltt}  % 
\newenvironment{demo}
  {\begin{alltt}\leftskip3em
     \def\\{\ttfamily\char`\\}%
     \def\{{\ttfamily\char`\{}%
     \def\}{\ttfamily\char`\}}}
  {\end{alltt}}
 
% metafont font.  If logo not available, use the second form
%
% \font\mffont=logosl10 scaled\magstep1
\let\mffont=\sf
% --- end-of-sample-stuff ---
 



\begin{document}
 
% ==========   Preliminary pages
%
% ( revised 2012 for electronic submission )
%

\prelimpages
 
%
% ----- copyright and title pages
%
\Title{Computational aspects of modular parametrizations \\ of elliptic curves}
\Author{Hao Chen}
\Year{2011-2016}
\Program{UW Mathematics}

\Chair{William Arthur Stein}{Professor}{Department of Mathematics}
\Signature{First committee member}
\Signature{Next committee member}
\Signature{etc}

\copyrightpage

% \titlepage  

% --- sample stuff only -----
% unusual footnote not found in a real thesis
% You just use the \titlepage as commented out above

{\Degreetext{A dissertation 
  submitted in partial fulfillment of the\\ requirements for the degree of}
 \def\thefootnote{\fnsymbol{footnote}}
 \let\footnoterule\relax
 \titlepage
 }
\setcounter{footnote}{0}

% --- end-of-sample-stuff ---
 
%
% ----- signature and quoteslip are gone
%

%
% ----- abstract
%


\setcounter{page}{-1}
\abstract{
Abstract goes here.
}
 
%
% ----- contents & etc.
%
\tableofcontents
%\listoffigures
%\listoftables  % I have no tables
 
%
% ----- glossary 
%
\chapter*{Glossary}      % starred form omits the `chapter x'
\addcontentsline{toc}{chapter}{Glossary}
\thispagestyle{plain}
%
\begin{glossary}
\item[argument] replacement text which customizes a \LaTeX\ macro for each particular usage.
\end{glossary}
 
%
% ----- acknowledgments
%
%\acknowledgments{% \vskip2pc
  % {\narrower\noindent
%  The author wishes to express sincere appreciation to
%  University of Washington, where he has had the opportunity
%  to work with the \TeX\ formatting system,
 % and to the author of \TeX, Donald Knuth, {\it il miglior fabbro}.
  % \par}
%}

%
% ----- dedication
%
\dedication{\begin{center} to all of you\end{center}}

%
% end of the preliminary pages
 
 
 
%
% ==========      Text pages
%

\textpages

\chapter{Introduction}

\chapter{Computing the Mazur Swinnerton-Dyer critical subgroup of elliptic curves}

\chapter{Chow-Heegner points computations} 
 
% ========== Chapter 1

\chapter{Fourier expansions of modular forms forms at all cusps}

Let $k$ be a positive even integer and let $f \in S_k(\Gamma_0(N))$ be a nonzero cusp form.
Then $f$ has a Fourier expansion at the cusp infinity: $$f = \sum_{n \geq 1} a_n q^n$$
where $a_n$ are complex numbers and $q = e^{2 \pi i \tau}$. 
We are concerned with the problem of computing the Fourier expansion of $f$ at other cusps. When $N$ is 
square-free, this problem is solved by Asai \cite{asai1976fourier}.  The problem is studied in the Ph.D. thesis of Christophe Delaunay and in [Edixhoven], where a numerical algorithm is proposed. We will give a numerical algorithm to compute such expansions.  Our approach is different from the one proposed in [Ed], for they require working at a higher level: to compute expansions at cusps of denominator $Q$, one needs to compute period matrices for forms of level $NR^2$, where $R = \gcd(Q, \frac{N}{Q})$. As a contrast, our algorithm works at levels dividing $N$. 

The main results of this chapter are Theorem~\ref{thm: ExpansionFormula} and Algorithm~\ref{alg: qexp}. The former gives a formula for the Fourier expansion of a newform $f \in S_k(\Gamma_0(N))$ at any cusp $z$ of width one, and the latter describes how to use the formula to explicitly compute such expansion. Along the way, we will develop algorithms to compute the twists $f \otimes \chi$ and the pseudo-eigenvalue of newforms under the Fricke involution. 

Section contains some examples. % In section, we describe an alternative approach and 

\section{Preliminaries}

Let $N \geq 1$ be an integer and let $X_0(N)$ be the modular curve of level $N$. 
\begin{Definition}
Let $z$ be a cusp on $X_0(N)$.  If $z \neq \infty$, write $z = [a/c]$ with $\gcd(a,c) =1$. The {\it denominator} of $z$ is $$d_z  = \gcd(c,N).$$. If $z = \infty$, we set $d_\infty = N$. Choose $\alpha \in SL_2(\bZ)$ such that $\alpha(\infty) = z$. 
The {\it width} of $z$ is 
\[
	h_z = \left| \frac{SL_2(\bZ)_\infty}{(\alpha^{-1} \{\pm I\} \Gamma_0(N) \alpha)_\infty}\right|
\]
where the subscript $\infty$ means taking  the isotropy subgroup of $\infty$ in the corresponding group.
\end{Definition}

The width of a cusp can be computed in terms of its denominator. In fact, we have
\begin{Lemma}
If $z$ is a cusp on $X_0(N)$, then
$$h_z = \frac{N}{\gcd(d_z^2, N)}.$$
\end{Lemma}

\begin{proof}
When $z = [\infty]$, we have $d_\infty = N$ and $h_\infty =  1$, so the formula holds trivially. Otherwise, write $z = [\frac{a}{c}]$ and find $\alpha = \abcd{a}{b}{c}{d} \in SL_2(\bZ)$. For $N' \in \bZ$ we compute 
\[
	\alpha   \abcd{1}{N'}{0}{1} \alpha^{-1} = \abcd{*}{*}{-c^2N'}{*}.
\]
Hence $\abcd{1}{N'}{0}{1}  \in  (\alpha^{-1} \{\pm I\} \Gamma_0(N) \alpha)_\infty \iff N \mid c^2 N' \iff \frac{N}{\gcd(d_z^2, N)} \mid N'$. This completes the proof.
\end{proof}

In particular, the width of a cusp $z$ is one if and only if $N \mid d_z^2$. 

Suppose $f$ is a modular form on $\Gamma_0(N)$ of positive even weight $k$ and $\alpha \in GL_2(\bQ)$. Recall the weight-$k$ action is defined as 
\[
	f | \alpha (z)  = (\det(\alpha))^{k/2} (cz+d)^{-k} f(\alpha z), \, \alpha = \abcd{a}{b}{c}{d}.
\]
In particular, if $\alpha \in SL_2(\bZ)$, then $f | \alpha $ is a modular form on $\Gamma(N)$. So $f | \alpha $ has a $q$-expansion, which is a power series in $q^{\frac{1}{N}}$. A natural thing to do is to define the expansion of $f$ at the cusp $z$ as the expansion of $f | \alpha$. However,  note that this may not be well-defined: in general the expansion depends on the choice of $\alpha$. Nonetheless, when the cusp $z$ has width one, the expansion is indeed well-defined as a power series in $q$. 

\begin{Lemma}
Let $z$ be a cusp on $X_0(N)$ with $h_z = 1$. Choose $\alpha \in SL_2(\bZ)$ such that 
$\alpha(\infty) =z$. Then $f | \alpha$ is a cusp form on $\Gamma_1(N)$. Moreover, the function $f|\alpha $ is independent of the choice of $\alpha$. 
\end{Lemma}

\begin{proof}
It is easy to verify that $\Gamma_1(N) \subseteq \alpha^{-1} \Gamma_0(N) \alpha$, hence the first claim holds. Now suppose $\beta \in SL_2(\bZ)$ is such that $\beta(\infty) = z$. Then $\alpha^{-1} \beta \in SL_2(\bZ)_\infty$. Since $z$ has width one, we have $\alpha^{-1} \beta \in \alpha^{-1}\Gamma_0(N) \alpha$. Hence $\beta \in \Gamma_0(N) \alpha$, and it follows that $f | [\beta] = f | [\alpha]$.
\end{proof}

In light of the lemma above, we define the {\it $q$-expansion of $f$ at a width one cusp $z$} to be the $q$-expansion of $f | [\alpha]$, and denote it by $f_z$. 


Assume further that $f$ is an eigenform under the Atkin-Lehner operators. We will show that in order to compute the expansion of $f|[\alpha]$ for any $\alpha \in SL_2(\bZ)$, it suffices to do so for $\alpha = \abcd{1}{0}{m}{1}$, where $0 \leq m < N$ and $N \mid \gcd(m,N)^2$. In particular, it suffices to compute the expansions of $f$ at a some cusps of width one.

\begin{Lemma}
For any $\alpha \in SL_2(\bZ)$, there exists a matrix $w_Q \in W_N$ and an upper triangular matrix $u \in GL_2(\bQ)$
such that $w\alpha = \alpha' u$, where $\alpha' = \abcd{a'}{b}{c'}{d'} \in SL_2(\bZ)$ satisfies $N \mid \gcd(N,c')^2$.
\end{Lemma}

Indeed, one may find $Q$ using Lemma. Now $f|[\alpha] = f|[w_Q][w_Q\alpha] = f|[w_Q][\alpha'][u] = \lambda_Q(f) f [\alpha'][u] =\lambda_Q(f) f[\alpha''][u]$, where $\alpha''$ is of form $\abcd{1}{0}{m}{1}$. Note that for an upper triangular matrix $u = \abcd{u_0}{u_1}{0}{u_2}$, we have $f[u](q) = f(q^{u_0/u_2} e^{2\pi i u_1/u_2})$.

\section{Reducing to the case of newforms}

The space $S_k(\Gamma_0(N))$ is spanned by elements of form $g(q^d)$, where $g$ is newform of level $M \mid N$ and $d$ is a divisor of $\frac{N}{M}$.  Note that $g(q^d) = d^{-k/2} g | \abcd{d}{0}{0}{1}$. For any $\alpha \in SL_2(\bZ)$, 
we can find $\alpha' \in SL_2(\bZ)$ and $u \in GL_2(\bQ)$ such that $\abcd{d}{0}{0}{1} \alpha  = \alpha' u$. Hence to compute all expansions $f | [\alpha]$, it suffices to give an algorithm for newforms.

In the rest of this chapter, we will restrict ourselves to solving the following problem: 

\begin{problem}
Let $f$ be a normalized newform in $S_k(\Gamma_0(N))$ and $z$ be a cusp on $X_0(N)$ of width one. Compute the $q$-expansion of $f_z$.
\end{problem}


\section{Twists of newforms}

For $f \in S_k(\Gamma_1(N), \epsilon)$ a newform with expansion $f = \sum_n a_n(f) q^n$ and $\chi$ a Dirichlet character, the {\it twist} $f_\chi$ is a modular form with expansion $f_\chi (q) = \sum a_n(f) \chi(n)  q^n$. 

\begin{Lemma}\cite[Proposition 3.1]{atkin1978twists}
Let $F \in S_k(\Gamma_1(N), \epsilon)$, where $\epsilon$ is a character of conductor $N'$.  Let $\chi$ be a character modulo $M$. Put $\tilde{N} = lcm(N, N'M, M^2)$. Then $f_\chi \in S_k(\Gamma_1(\tilde{N}), \epsilon \chi^2)$.
\end{Lemma}

In particular, when $\epsilon$ is the trivial character and the conductor $M$ of $\chi$ satisfies $M^2 \mid N$, we have
$F_\chi \in S_k(\Gamma_1(N), \chi^2))$.

We write $f \otimes \chi$ for the unique newform such that $a_p(f \otimes \chi) = a_p(f_\chi)$ for all but finitely many primes $p$. From now, we refer to $f \otimes \chi$ as {\it the twist of $f$ by $\chi$}. 

We quote two more results from \cite{atkin1978twists}, which we will use extensively. First, we recall the definitions of  $U_d$ and $B_d$ operators. For a modular form $f = \sum a_n q^n$ and a positive integer $d$, we put 
\[
	f |U_d = \sum a_{nd} q^n, \,  f |B_d = \sum a_n q^{nd}.
\]
It is easy to see that for any positive integers $d,d'$, we have $U_d$ commutes with $B_{d'}$.





\begin{Lemma}\cite[Theorem 3.1]{atkin1978twists} \label{lemma: winnie-level}
Let $q \mid N$ and $Q$ be the $q$-primary part of $N$. Write $N = QM$. Let $F$ be a newform in $S_k(\Gamma_1(N), \epsilon)$ with $\cond(\epsilon_Q) = q^{\alpha}, \alpha \geq 0$. Let $\chi$ be a character with conductor $q^{\beta}$, $\beta \geq 1$. Put $Q' = \max\{Q,q^{\alpha + \beta}, q^{2\beta}\}$. Then \\
(1)  For each prime $q' \mid M, F_\chi$ is not of level $Q'M/q$. \\
(2)  The exact level of $F_\chi$ is $Q'M$ provided (a) $\max\{q^{\alpha + \beta}, q^{2\beta}\} < Q$ if $Q' = Q$, or 
(b) $\cond(\epsilon_Q \chi) = \max \{q^{\alpha}, q^{\beta} \}$ if $Q' > Q$.
\end{Lemma}


\begin{Lemma}\cite[Theorem 3.2]{atkin1978twists} \label{lemma: fchi}
Let $q \mid N$ and $Q$ be the $q$-primary part of $N$. Write $N = QM$. Let $\chi$ be a character whose conductor equals a power of $q$.  Let $f$ be a newform in $S_k(\Gamma_1(N), \epsilon)$. Then $f \otimes \chi$  is a newform in $S_k(\Gamma_1(Q'M,\epsilon \chi^2)$, where $Q'$ is a power of $q$. Moreover, we have $$f_\chi  = f \otimes \chi - (f \otimes \chi) |U_q |B_q.$$
\end{Lemma}

Since our goal is to compute expansions of newforms on $\Gamma_0(N)$, we will make the following assumptions: 
from now, unless otherwise noted, we assume $f$ has trivial character, and that $\cond(\chi)^2 \mid N$.


Next, we consider the problem of identifying the newform $f \otimes \chi$. This includes finding its level and its $q$-expansion to arbitrarily many terms. We will assume that we have an oracle which, given weight $k$ and level $N$, computes the expansions of all newforms in $S_k(\Gamma_1(N))$ to arbitrarily many terms (for example, use the algorithm in \cite{stein2007modular}).

Now we proceed on how to recognise the level of $f \otimes \chi$ from the coefficients of $f$. One potential obstacle is that we do not know all Fourier coefficients of $f \otimes \chi$: we only know that $a_n(f \otimes \chi)  = a_n(f)\chi(n)$   when $\gcd(n, N) = 1$. This can be overcome using a variant of Sturm's argument. First we prove a lemma.
\begin{Lemma}
Let $f \in S_k(N, \epsilon)$ be a normalized newform and $q$ be any positive integer. Then $f|U_q|B_q \in S_k(Nq^2, \epsilon)$.
\end{Lemma}

\begin{proof}
It is a standard fact that for any integer $d \geq 1$, the map $f \mapsto f|B_d$ takes $S_k(N, \epsilon)$ to 
$S_k(Nd, \epsilon)$. To prove the lemma, we consider two separate cases. First, assume $q \nmid N$, then we have 
$T_q = U_q + q^{k-1} \epsilon(q) B_q$. By our assumption, we have $f|T_q = a_q(f) f$. Therefore, we have 
$f|U_q|B_q = f|(T_q - q^{k-1} \epsilon(q) B_q)|B_q = a_q(f)f|B_q - q^{k-1} \epsilon(q) f|B_q^2$. Hence $f|U_q|B_q \in S_k(Nq^2, \epsilon)$. \\
Now assume $q \mid N$, so $U_q = T_q$. Hence $f|U_q|B_q = a_q(f) f|B_q \in S_k(Nq, \epsilon) \subseteq  S_k(Nq^2, \epsilon)$. 
\end{proof}

The next proposition generalised the usual Sturm bound argument for modular forms. 

\begin{Prop}
Let $g_1$, $g_2$ be two normalised newforms of levels $N_1 \mid N_2$ and the same nybentypus character $\epsilon$. Assume $\epsilon$ has prime power conductor $Q = q^\beta$ such that  $Q^2 \mid N_1$. Let 
$B$ be the Sturm bound for the congruence subgroup $\Gamma_1(Nq^2)$. Suppose 
\[
	a_n(g_1) = a_n(g_2), \, \mbox{for all }1 \leq n \leq B \mbox{ such that } \gcd(n,q) = 1.
\]
Then $g_1 = g_2$. 
\end{Prop}

\begin{proof}
Following \cite{atkin1978twists}, we define the operator $K_q$ on the space of modular forms by
\[
	g|K_q = g - g|U_q|B_q. 
\]
Then the assumption is equivalent to the statement that $\delta  = (g_1 -g_2) |K_q$ has $a_n(\delta) = 0$ for all $1 \leq n \leq B$. Since $\delta \in S_k(Nq^2, \epsilon)$,  Sturm's theorem implies $\delta = 0$. We then know from \cite[Theorem 5.7.1]{diamond2006first}  that $g_1 - g_2 \in S_k(N_2,\epsilon)^{old}$. Suppose $N_1 < N_2$, then $g_1$ is in the old subspace, hence so is $g_2$, a contradiction. Therefore we must have $N_1 = N_2$. It follows that $g_1 - g_2 \in S_k(N_2, \epsilon)^{new}$, since $g_1, g_2$ are newforms. Since the new subspace and the old subspace intersect trivially, we must have $g_1 - g_2  = 0$. 
\end{proof}

Now we are ready to describe the algorithm. 

\begin{algorithm}[H]
\caption{Identifying  $f \otimes \chi$}
\label{alg: twist}
\begin{algorithmic}[1]
    \Require $k$ -- a positive even integer; $f \in S_k(\Gamma_0(N))$ a normalized newform; $\chi$ a Dirichlet character of prime power conductor $Q = q^\beta$; $Q^2 \mid N$;  $B$ -- a positive integer
    \Ensure The level $M_\chi$ of $f \otimes \chi$ and the Fourier expansion of $f \otimes \chi$ up to $q^B$.
    \If{$Q = 1$}
    \State return $N$.
    \EndIf
    \State $Q' := \cond(\chi^2)$; $N_0 := \frac{N}{q^{v_q(N)}}$; $M_0 := Q'N_0$; $t := \frac{N}{M_0} \in \bZ$. 
    \For{each positive divisor $d$ of $t$}
    	\State Set $V_d := S_k(M_0d, \chi^2)$. 
	\State Compute a basis of newforms $\{g_1^{(d)}, \cdots g_{s_d}^{(d)}\}$ of $V_d$.
    	\State Set $B_d$ := the Sturm bound for $\Gamma_1(M_0dq^2)$. 
    	\For{$1 \leq j \leq s_d$} 
		\If{$a_n(g_i^{(d)})= a_n(f)\chi(n)$ for all $1 \leq n \leq B_d, \gcd(n,q) = 1$}
			\State \Return $M_0d$.
		\EndIf
	\EndFor
    \EndFor	
\end{algorithmic}
\end{algorithm}

%It is natural to define {\it $p$-minimality} of newforms. The definition mimics that of [Brunault]. 

%\begin{Definition}
%Let $f \in S_k(\Gamma_1(N))$ be a newform. Let $p$ be a prime such that $p^2 \mid N$. 
%We say $f$ is {\it $p$-minimal} if $f \otimes \chi$ is new of level $N$ for all Dirichlet character 
%$\chi: (\bZ/p^{\frac{v_p(N)}{2}}\bZ)^{\times} \to \bC^{\times}$.
%\end{Definition}

We give some sample computations applying the above algorithm. 

\begin{Example}
Let $f$ be the normalised newform attached to the elliptic curve 
\[
	E: y^2 + x y + y = x^{3} -  x - 2
\]
of Cremona label {\bf 50a}. Then $f \otimes \chi$ is new of level 50 for all Dirichlet characters $\chi$ with modulus 5. 
In other words, $f$ is 5-minimal. 
\end{Example}

As another example, we demonstrate a newform which is not $p$-minimal. 
\begin{Example}
Let $f$ be the normalised newform attached to the elliptic curve 
\[
E: y^2 + x y = x^{3} + x^{2} - 25 x - 111
\]
of label {\bf 98a}. Let $\chi$ be the Dirichlet character modulo 7 defined by $\chi(3 \pmod{7}) = -1$. 
We found that $f \otimes \chi$ is a newform of level 14, with $q$-expansion
\[
 (f \otimes \chi) (q) = q - q^{2} - 2q^{3} + q^{4} + 2q^{6} + q^{7} - q^{8} + q^{9} - 2q^{12} - 4q^{13} - q^{14} + O(q^{15}).
\]
\end{Example}


\section{Pseudo-eigenvalues} 

Let $\epsilon$ be a Dirichlet character modulo $N$ and let $f$ be a newform in $S_k(N,\epsilon)$. For any divisor $Q$ of $N$ with $\gcd(Q, \frac{N}{Q}) =1$, there is an algebraic number  $w_Q(f)$ of absolute value one  and  a newform $g$ in $S_k(N, \overline{\epsilon_Q} \epsilon_{N/Q})$ such that 
\[
	W_Q(f) = w_Q(f) g, 
\]


\begin{Definition}
The number $w_Q(f)$ is called the {\it pseudo-eigenvalue} of $W_Q$ on $f$. 
\end{Definition}
For ease of notations, we write $w(f) = w_N(f)$. 

For a power series  $f = \sum_{n \geq 0} a_nq^n$, its complex conjugate, denoted by $f^*$, is $$f^*(q) = \sum \overline{a_n}q^n.$$ 

From \cite{atkin1978twists} we have $W_N(f) = w(f) f^*$. In the rest of this section, we describe an algorithm to efficiently compute $w(f)$ numerically.  For a positive even integer $k$, let $\bM(k)$ denote the space of weight-$k$ modular symbols defined in \cite{stein2007modular}. The space $\bM(k)$ is a quotient of $\bZ[X,Y]_{k-2} \otimes \bP^1(\bQ)^2$, and $GL_2(\bQ)$ acts on $\bM(k)$ via the following rule
\[
	g (P(X,Y) \otimes \{\alpha, \beta\}) = P( g^{-1}(X,Y)^T) \{g(\alpha), g(\beta)\}.
\]
Most importantly, there is a pairing between $\bM(k)$ and the space of modular forms of weight $k$, defined as
\[
		\langle f, P(X,Y) \otimes \{\alpha, \beta\}) \rangle_k = \int_{\alpha}^{\beta} f(z) P(z,1) dz.
\]
We will suppress the subscript $k$ if its value is clear from context.


\begin{Lemma}
Let $M \in \bM(k)$ and $f \in S_k(\Gamma_1(N))$. Then 
\[
	N^{\frac{k}{2}-1} \langle f|W_N, M \rangle = \langle f, W_N M \rangle.
\]
\end{Lemma}

\begin{proof}
See proof of  \cite[Proposition 8.17]{stein2007modular}. Note that the extra factor $N^{\frac{k}{2}-1}$ is due to the different constants involved in the definition of the weight-$k$ action of $GL_2(\bQ)$ on modular forms. 
\end{proof}

The map  
\[
	*: P(x,y)\{\alpha, \beta\} \mapsto P(-x,y) \{-\bar{\alpha}, -\bar{\beta}\} 
\]
defines the {\it star involution} on the space $\bM(k)$. We have $\langle f^*, M \rangle = \overline{\langle f, M^*\rangle}.$


\begin{Lemma}
Let $f$ be a normalised newform on $\Gamma_1(N)$ with positive even weight $k$ and let $M \in \bM(k)$ be such that $W_N(M) = N^{k/2 -1} M^*$. Assume $\langle f, M \rangle \neq 0$.  Then 
\[
	w(f) = \frac{\langle f,M \rangle }{\overline{\langle f,M \rangle}}.
\]
\end{Lemma} 

\begin{proof}
Since $W_N^2(M) = N^{k-2}M$ for all $M \in \bM(k)$, the assumption implies $W_N(M^*) = N^{k/2 -1} M$. 
Now 
\begin{align*}
& N^{k/2-1} \langle f|W_N, M^* \rangle  = \langle f,W_N(M^*) \rangle \\
\implies & N^{k/2-1} w(f) \langle   f^*,M^* \rangle = N^{k/2-1} \langle f, M \rangle \\
\implies & w(f) = \frac{\langle f, M \rangle}{\langle f^*,M^* \rangle} \\ 
\implies &	w(f) = \frac{\langle f, M \rangle}{\overline{\langle f, M \rangle}}.
\end{align*}
\end{proof}

Suppose $\alpha, \beta$ are distinct points on the arc $\{z \in \bC | Im(z) > 0,  |z| = 1/\sqrt{N}\}$. Then it is easy to verify that $M = (xy)^{k/2-1} \otimes \{\alpha, \beta\}$ satisfies $W_N(M) = M^*$. Finally, we arrive at the algorithm to compute $w(f)$.




\begin{algorithm}[H] 
\caption{Computing the pseudo-eigenvalue of newforms.}
\label{alg: pseudo-eigenvalue}
\begin{algorithmic}[1]
    \Require $k$ -- a positive even integer. $f \in S_k(\Gamma_1(N))$ a normalized newform.    
    \Ensure a numerical approximation of $w(f)$.
    \State $n_0 := 10$, $z_0 := \frac{i}{\sqrt{N}}$. $\delta = 10^{-3}$. 
    \State Randomly generate $n_0$ points $\{z_1, \cdots, z_{N_0}\} \subseteq \{z | 0 < Im(z) < \frac{1}{2\sqrt{N}}, |z| = \frac{1}{\sqrt{N}} \}$.
    \For{$1 \leq i \leq n_0$}
    	\State compute the period integral $c_i =  \int_{z_0}^{z_i} 2\pi i f(z) z^{\frac{k-2}{2}} dz$. 
	\State $w_i \gets c_i/\bar{c_i}$. 
    \EndFor
    \If{the standard deviation of $w_1, \cdots, w_{n_0}$ is less than $\delta$} 
     \State $w \gets \frac{1}{n_0}(\sum_i w_i)$. 
     \State \Return $w$.
    \Else
    	\State \Return {\bf FAIL}. 
    \EndIf
\end{algorithmic}
\end{algorithm}

%\begin{Remark}
%The period integral in step 4 of Algorithm~\ref{alg: pseudo-eigenvalue} is computed as follows: 
%This approach is taken from [Cre97].
%\end{Remark}


\section{Formula for the Fourier expansion of $f$ at width one cusps: Part 1}

First we recall some notations from \cite{atkin1978twists}.
\begin{Definition}
For a positive integer $c'$, let $S_c' = \abcd{1}{\frac{1}{c'}}{0}{1}$. If $\chi$ is a character modulo $c'$, we define the 
operator on modular forms 
\begin{equation*}
\label{formula: RS}
	f | R_\chi(c') = \sum_{u =0}^{c'-1} \bar{\chi}(u) f | S_{c'}^u.
\end{equation*}
\end{Definition}
Write $R_\chi$ in short for $R_\chi(\cond(\chi))$. Note that $f|R_\chi = g(\bar{\chi})f_\chi$.
Conversely, if $(a,M) = 1$, we have 
\begin{equation}
\label{formula: SR}
	\phi(c')S_{c'}^u = \sum_{\chi: cond(\chi) \mid c'} \chi(u) R_\chi(c').
\end{equation}

For our convenience, we define some operators, which are essentially the conjugates of $S_c'$ and $R_\chi(c')$ by $W_N$. Let $A_c' = \abcd{1}{0}{c'}{1}$.  Then it is easy to verify the following matrix identity.
\begin{Fact}
$-N \cdot A_{N/c'}^{-1} = W_N S_{c'} W_N$.
\end{Fact}

From now on, we assume $c$ is a divisor of $N$ and $c' = \frac{N}{c}$. Then as operators on modular forms, 
\[
	A_c^{-1} = W_N S_{c'} W_N.
\]

Since $W_N^2 = id$ as operators, we have
\[
	A_c^{-u} = W_N S_{c'}^u W_N, \, \forall u \in \bZ. 
\]

Parallel to the notion of $R_\chi(c')$, let $\Phi_\chi(c) = \sum_{u =0}^{c'-1} \bar{\chi}(u) A_c^{-u}$.Then $\Phi_\chi(c) = W_N R_\chi(c') W_N$. 
Similar to Formula~\ref{formula: SR}, we have
\begin{equation}
\label{formula}
	\varphi(c') A_c^{-a} = \sum_{\cond(\chi) \mid c'} \chi(a) \Phi_\chi(c) 
	 = \sum_{\cond(\chi) \mid c'} \chi(a) W_N R_\chi(c') W_N. 
\end{equation}

Applying Formula~\ref{formula} to $f$, we arrive at
\begin{eqnarray} \label{expansion0}
	f_{[\frac{a}{c}]} \left( q\right) &= \frac{1}{\varphi(c')}\sum_{\cond(\chi) \mid c'} \chi(-a) f| W_N R_\chi(c') W_N. \\ 
	&= \frac{w(f) }{\varphi(c')}\sum_{\cond(\chi) \mid c'} \chi(-a) f| R_\chi(c')  W_N. 
\end{eqnarray}

Now it left to compute the expansions of  each $f| R_\chi(c') W_N$ in the sum.

\section{Formula for the Fourier expansion of $f$ at width one cusps: Part 2}

In this section, we describe how to compute the expansion of $f| R_\chi(c') W_N$. First note that $T_p = U_p  + \epsilon(p) p^{\frac{k}{2}}B_p$ as operators on $S_k(\Gamma_1(N), \epsilon)$. It follows that $T_p$ commutes with $B_d$ for any positive integer $d$. 
 

We recall some notations and a result from \cite{delaunay2002thesis}.
\begin{Definition}\cite[Definition III.2.4]{delaunay2002thesis}
For a Dirichlet character $\chi$ modulo $b = \prod_{j \in J} p_j^{\alpha_j}$. Let $r = |J|$. Decompose $\chi$ uniquely as 
$\chi = \chi_1 \cdots \chi_r$, where $\chi_i$ is a character modulo $p_j^{\alpha_j}$.  We define $\cond'(\chi)$ multiplicatively, by putting 
\begin{equation} \label{modified conductor}
	\cond'(\chi_j) = \begin{cases} \cond(\chi_j) & if \cond(\chi_j) > 1 \\ p_j & else \end{cases}
\end{equation}
Also, if $I = \{j \in J : \chi_j \mbox{ is trivial character modulo } p_j^{\alpha_j}\}$, we put $tr = \prod_{j \in I} p_j^{\alpha_j} $
$nt = b/tr$,  $\chi_{tr} = \prod_{j \in I} \chi_j$, and $\chi_{nt} = \chi/\chi_{tr}$. Then we set
\begin{equation} \label{modified gauss sum}
	g'(\chi) = (-1)^{|I|} \chi_{nt}(tr) g(\chi_{nt}). 
\end{equation}
Here $g(\chi)$ is the usual Gauss sum of $\chi$: if $\chi$ is a character modulo $d$, then $g(\chi) = \sum_{a=1}^{d} e^{\frac{2\pi i a}{d}} \chi(a)$. If $\chi = \chi_0$ is the trivial character, we set $g(\chi_0) = 0$. 
\end{Definition}


\begin{Lemma}\cite[Prop 2.6]{delaunay2002thesis} \label{lemma of delaunay}
Let $c'$ be an integer such that $c'^2 \mid N$. For a Dirichlet character $\chi$ mod $c'$, we have
$$f|R_{\chi}(c') = \begin{cases} g'(\bar{\chi}) f_{\chi_{nt}} & if \cond'(\chi) = c' \\ 0 & else.  \end{cases}$$
\end{Lemma}

Using this lemma, we can simplify formula \ref{expansion0} to 
\begin{equation} \label{expansion01}
	f_{[\frac{a}{c}]}= \frac{w(f) }{\varphi(c')}\sum_{\cond'(\chi) = c'} \chi(-a)g'(\bar{\chi}) f_{\chi_{nt}} | W_N. 
\end{equation}


Next, we compute $f_{\chi_{nt}}$ by the following: suppose $g  = f \otimes \chi_{nt}$. Then 
\begin{equation} \label{twistformula1}
	f_{\chi_{nt}} =  g |\prod_{i=1}^r K_{p_i}.
\end{equation}
Moreover, we have 
\begin{equation} \label{twistformula2}
K_{p} = 1  - U_{p} B_p =  \begin{cases} 1- (T_p - \chi_{nt}^2(p) p^{\frac{k}{2}} B_p) |B_p & p \nmid M \\  1 - T_p |B_p & p \mid M \end{cases}.
\end{equation} Using the commutativity of $T_*$ and $B_*$, we can write  $f_{\chi_{nt}}$ in the form $\sum c_i (f \otimes \chi)(q^{d_i})$, where $c_i$ and $d_i$ are constants. To give a precise formula, we use the following notation. For a finite set $S$ of integers, let $\pi(S) = \prod_{s \in S} s$ denote the product of all elements in $S$. For a Dirichlet character $\chi$ of conductor $d$, let $S_\chi$ be the set of prime divisors of $d$. For any positive integer $M$ and any finite set of integers $S$, define 

\begin{equation} \label{index set}
\cB_{S,M} = \{(S_1, S_2) \in (2^\bZ)^2 | S_1, S_2 \subseteq S, S_1 \cap S_2 = \emptyset, \gcd(M, \pi(S_2)) = 1\}
\end{equation} 

\begin{Prop} \label{thm: formula1}
Let $k \geq 2$ be an even integer and let $f$ be a newform in $S_k(\Gamma_0(N))$. Then 
	$$f_{\chi_{nt}} =  \sum_{(S_1, S_2) \in \cB_{S_\chi,M}} (-1)^{|S_1|}a_{\pi(S_1)}(g_\chi)  \pi(S_2)^{k/2} \chi_{nt}^2(\pi(S_2)) g_\chi | B_{\pi(S_1) \pi(S_2)^2}.$$
Here $g_\chi = f \otimes \chi$, $M$ is the level of $g_\chi$ and $\cB_{S_\chi,M}$ is as in  \ref{index set}.
\end{Prop}

\begin{proof}
This is a direct consequence of multiplying out \ref{twistformula1} using \ref{twistformula2}, using the fact that $T_p$ commutes with $B_d$, and noting that $T_p$ acts as multiplication by $a_p(g_\chi)$ on $g_\chi$.
\end{proof}

Theorem~\ref{thm: formula1} will be our starting point of computing the expansion of $f$ at width one cusps. 
We will use it to compute $f_{\chi_{nt}} | W_N$.  First we prove two lemmas. 
\begin{Lemma} \label{lemma: bdwn}
Let $f$ be a newform of even weight $k$ on $\Gamma_1(M)$ and suppose $d, N$ are positive integers such that $Md \mid N$. Then
   $$f| B_d|W_N = \left(\frac{N}{Md^2} \right)^{k/2}  w(f)  (f|B_{\frac{N}{Md}})^{*}.$$
\end{Lemma}
\begin{proof} Straightforward computation.
\begin{align*}
f |B_d | W_N & = d^{-k/2} f | \abcd{d}{0}{0}{1} \abcd{0}{-1}{N}{0} \\ 
& = d^{-k/2} f| \abcd{0}{-1}{M}{0} \abcd{N/md}{0}{0}{1} \abcd{d}{0}{0}{d} \\
& = \left( \frac{N}{Md^2} \right)^{k/2} f | W_M | B_{N/Md} \\
& = \left( \frac{N}{Md^2} \right)^{k/2} w(f) f^* | B_{N/Md} \\ 
& = \left( \frac{N}{Md^2} \right)^{k/2} w(f) (f | B_{N/Md})^*.
\end{align*}
\end{proof}

Before stating the second lemma, we quote another result in \cite{li1975newforms} on the coefficients of a newform at primes dividing the level.
\begin{Lemma}\cite[Theorem 3 (iii)]{li1975newforms}  \label{lemma: winnie-vanishing}
Let $f = \sum_{n \geq 1} a_n(f) q^n$ be a normalized newform in $S_k(\Gamma_1(N), \epsilon)$ and let $p$ be a prime dividing $N$.  Then \\
(1) If $\epsilon$ is a character modulo $N/p$ and  $p^2 \mid N$, then $a_p(f) = 0$. \\ 
(2) If $\epsilon$ is a character modulo $N/p$ and  $p^2 \nmid N$, then $a_p(f)^2 = \epsilon(p) p^{k-2}$. \\ 
(3) If $\epsilon$ is not a character modulo $N/p$, then $|a_p(f)| = p^{\frac{k-1}{2}}$.
\end{Lemma}


\begin{Lemma} \label{lemma: well-definedness}
Keep the notations in Proposition~\ref{thm: formula1}. If $(S_1, S_2) \in \cB_{S_\chi,M_\chi}$ is such that $a_{\pi(S_1)}(g_\chi) \neq 0$. Then 
$M \pi (S_1) \pi(S_2)^2 \mid N$.
\end{Lemma}

\begin{proof}
Let $p$ be a prime divisor of $N' := M \pi(S_1) \pi(S_2)^2$. If $p \nmid M$, then $\ord_p(N') \leq \ord_p(\cond(\chi)^2) \leq \ord_p(N)$. So we assume $p \mid M$, hence $p \nmid p(S_2)$. If $p \nmid p(S_1)$, then there's nothing to prove; 
if $p \mid \pi(S_1)$, we want to show that $\ord_p(M) < \ord_p(N)$. Suppose not, then $\ord_p(M) = \ord_p(N) \geq 2 \ord_p(\cond(\chi))$. Since $\cond(\chi^2) \leq \cond(\chi)$, we know $\chi^2$ is a character modulo $M/p$. Applying case (1) of Lemma~\ref{lemma: winnie-vanishing} to the newform $g_\chi$, we see that $a_{p}(g_\chi) = 0$, hence $a_{\pi(S_1)}(g_\chi) = 0$ by multiplicativity.
\end{proof}

Now we can state our main theorem from this chapter.
% Main Theorem of expansion 

\begin{theorem} \label{thm: ExpansionFormula}
Let $k \geq 2$ be an even integer and let $f$ be a normalized newform in $S_k(\Gamma_0(N))$. Let $z$ be a cusp on $X_0(N)$ of width one. Write $z = \left[ \frac{a}{d} \right]$ such that $\gcd(a,d) = 1$, $d \mid N$ and $N \mid d^2$. Let $d' = \frac{N}{d}$. Then the Fourier expansion of $f$  at the cusp $z$ is 
\[
	f_z(q) = \frac{w(f) }{\varphi(d')}\sum_{\chi: \cond'(\chi) = d'} \chi(-a) g'(\bar{\chi}) w(f \otimes \chi) f_\chi^{!}(q).
\]
Here

\begin{itemize}

\item $w(f)$ and $w(f \otimes \chi)$ are the pseudo-eigenvalues. 
\item $g'(\chi)$ is the modified Gauss sum defined in \ref{modified gauss sum} . 
\item $\cond'$ is the modified conductor of a Dirichlet character in \ref{modified conductor}. 
\item $f_\chi^{!}$ is as follows: let $M_\chi$ denote the level of  $f \otimes \chi$. Then
\[
f_\chi^{!} = \sum_{(S_1, S_2) \in \cB_{S_{\chi_{nt}},M_\chi}} (-1)^{|S_1|}a_{\pi(S_1)}(f \otimes \chi)  \left(\frac{N}{M_\chi \pi(S_1)^2 \pi(S_2)^3} \right)^{k/2}\chi^2(\pi(S_2)) (f \otimes \chi | B_{\frac{N}{M_\chi \pi (S_1) \pi(S_2)^2}})^*
\]
where the notations follow \ref{thm: formula1}.
\end{itemize}
\end{theorem}

\begin{proof}
We start from formula \ref{expansion01}:
$$f_{[\frac{a}{c}]}= \frac{w(f) }{\varphi(c')}\sum_{\cond'(\chi) = c'} \chi(-a)g'(\bar{\chi}) f_{\chi_{nt}} | W_N.$$
From \ref{thm: formula1}, we have 
	$$f_{\chi_{nt}} =  \sum_{(S_1, S_2) \in \cB_{S_\chi,M_\chi}} (-1)^{|S_1|} a_{\pi(S_1)}(f \otimes \chi)  \pi(S_2)^{k/2} \chi_{nt}^2(\pi(S_2)) f \otimes \chi | B_{\pi(S_1) \pi(S_2)^2}.$$
	To simplify notations, let $c(f, \chi, S_1, S_2) = (-1)^{|S_1|} a_{\pi(S_1)}(f \otimes \chi)  \pi(S_2)^{k/2} \chi_{nt}^2(\pi(S_2))$. Then 
\begin{align*}
	f_{\chi_{nt}} | W_N &= \sum_{(S_1, S_2) \in \cB_{S_\chi,M_\chi}} c(f, \chi, S_1, S_2) f \otimes \chi | B_{\pi(S_1) \pi(S_2)^2} W_N  \\
& =  \sum_{(S_1, S_2) \in \cB_{S_\chi,M_\chi}} c(f, \chi, S_1, S_2) \left(\frac{N}{M_\chi (\pi(S_1) \pi(S_2)^2)^2} \right)^{k/2} w(f\otimes \chi) (f \otimes \chi | B_{\frac{N}{M_\chi \pi (S_1) \pi(S_2)^2}})^* \\
& = w(f \otimes \chi) f_\chi^{!}. 
\end{align*}
Note that we applied Lemma~\ref{lemma: bdwn} to obtain the penultimate equality, and we could do that because of Lemma~\ref{lemma: well-definedness}. Now the result follows. 
\end{proof}



Theorem~\ref{thm: ExpansionFormula} gives us an algorithm to compute the expansion of $f_z$, which we will describe below. But first, we take a closer look at what ingredients goes into the expansion. Given a newform $f \in S_k(\Gamma_0(N))$ and a width one cusp $z$ of denominator $c$. We need to consider the twist of $f$ by all Dirichlet characters of conductor dividing $c$. 
For each such character $\chi$, we then need to determine the level $M_\chi$ and $q$-expansion of the newform $f \otimes \chi$, the latter boils down to knowing $a_p(f \otimes \chi)$ for all primes $p \mid \cond(\chi)$. Then we need to compute the pseudo-eigenvalues of $f \otimes \chi$. Finally, we combine these information together and apply Throem~\ref{thm: ExpansionFormula} to compute $f_z$. 

\begin{algorithm}[H]
\caption{Computing Fourier coefficients of $f$ at width one cusps}
\label{alg: qexp}
\begin{algorithmic}[1]
    \Require $f \in S_k(\Gamma_0(N))$ a newform; $a, c$ -- coprime integers such that $N \mid c^2$; $B$ -- a positive integer. 
    \Ensure The first $B$ Fourier coefficients of $f_{\left[\frac{a}{c} \right]}(q)$. 
    
    \State  $c' \gets N/c$. $X \gets$ The set of all Dirichlet characters $\chi$ such that $\cond'(\chi) = c'$. 
    \State compute $w(f)$  using Algorithm~\ref{alg: pseudo-eigenvalue}. 
    \For{$\chi$ in $X$}   
    	\State Using  Algorithm~\ref{alg: twist}, compute the level $M_\chi$ and the $q$-expansion of $g_\chi := f \otimes \chi$ to $B$ terms.
	\State Compute $w(g_\chi)$ using Algorithm~\ref{alg: pseudo-eigenvalue}.
    \EndFor
    \State Apply Theorem~\ref{thm: ExpansionFormula} to compute $f_z$ to $B$ terms. 
    \end{algorithmic}
\end{algorithm}

\section{A Converse Theorem}

Given the work in previous sections, it is a natural question then to ask whether the information on twists of $f$ is uniquely determined by the expansion of $f$ at width one cusps. The answer is yes, and the precise statement is in the following theorem. 

\begin{theorem}
Let $f$ be a normalized newform in $S_k(\Gamma_0(N))$. Assume the eigenvalue $w_N(f)$ is known. Suppose $c$ is a positive divisor of $N$ such that $N \mid c^2$.  Then the expansions of $f_z$, where $z$ runs through all cusps of denominator $c$, uniquely determines the following: for each Dirichlet character 
$\chi$ of such that $\cond'(\chi) = c'$, the level $M_\chi$, the pseudo-eigenvalue $w_{M_\chi}$ and the $q$-expansion of the newform $f \otimes \chi$. 
\end{theorem}

\begin{proof}
By plug in different $a$'s. We can solve for $t_\chi$.  Consider the first nonzero term of $t_\chi$. Suppose 
\[
	t_\chi = u_\chi q^{v_\chi} + O(q^{v_\chi + 1}), \, u_\chi \neq 0.
\]
Assuming that $\chi$ has prime power conductor $p^\beta > 1$, we claim that 
$$\left| \frac{v^{k/2}}{u} \right| = \begin{cases} p^{k/2} & if p \nmid M_\chi \\ p^{1/2} & if p \mid M_\chi \mbox{ and }  a_p(g) \neq 0 \\ 1 & else \end{cases}.$$

Proof of claim: the first and third case are easy to verify using Theorem~\ref{thm: ExpansionFormula}. Now assume $p \mid M$ and $a_p(g_\chi) \neq 0$. By Lemma~\ref{lemma: winnie-vanishing}, we have $|a_p(g_\chi)| = p^{k/2 - 1/2}$ or $p^{k/2 - 1}$. However, $|a_p(g_\chi)| = p^{k/2-1}$ only if $p \mid \mid M_\chi$ and $\chi^2$ is a character modulo $M_\chi/p$. This means $\chi^2$ is the trivial character. By Lemma~\ref{lemma: winnie-level}, we compute the $p$-level of $f = g_\chi \otimes \bar{\chi}$: note that $\max{p, p^{\alpha+\beta}, p^{2\beta}} > p$, so (ii) applies and the $p$-level of $f$ is equal to $\max(p^{\alpha}, p^{\beta})  = p^{\beta}$, i.e., $\ord_p(N) = \beta$. This is impossible since we have $p^{2 \beta} = \cond(\chi)^2 \mid N$. 

Therefore, we have $|a_p(g_\chi)| = p^{k/2-1/2}$ and the claim follows.

Since $k \geq 2$, we could determine which case we are in. Then we can read off $M_\chi$  and $w_M(g_\chi)$. For example, if we are in the second case, then the level can be computed via $M_\chi = \frac{N}{v_\chi p}$.  Now  the $N/M_\chi$'s coefficient of $t_\chi$ is 
\begin{eqnarray*}
	a_{\frac{N}{M}}(t_\chi) &= w(g_\chi) (\frac{N}{M})^{k/2} ( 1 -  |a_p(g_\chi)|^2 \chi^2(p) p^{-k/2} )  \\
	& = w(g_\chi) (\frac{N}{M})^{k/2} ( 1 - p^{k/2 -1} \chi^2(p)). 
\end{eqnarray*}

This allows us to solve $w(g_\chi)$. Finally, we compute $a_p(g_\chi)$ by $a_p(g) = \frac{-u_\chi}{w(g_\chi) \chi^2(p) (\frac{N}{Mp})^{k/2}}$. The value $a_p(g)$ determines the expansion of $g_\chi$. Recursively, we could solve for all $pn$-coefficients of $g_\chi$, from which we deduce it complete $q$-expansion. 


In the general case,  we consider the following subsets of $S_\chi$.  Let $S_1^* = \{ p \in S_\chi: p \mid M \}$, $S_2^* = 
S_\chi \setminus S_1^*$, and $\widetilde{S_1^*}= \{p \in S_1^*: a_p(g_\chi) \neq 0\}$.

It follows that the leading term of $t_\chi$ belongs to the summand corresponding to $(\widetilde{S_1^*}, S_2^*)$ in  Theorem~\ref{thm: ExpansionFormula}. Still writing the leading term as $u_\chi q^{v_\chi}$, we have 
\[
	u_\chi = w(g_\chi) \chi^2(p(S_2)) a_{p(\widetilde{S_1^*})}(g_\chi) p(\widetilde{S_1^*})^{-k} (p(S_2^*)^{-3k/2} \left(\frac{N}{M_\chi}\right)^{k/2}, v_\chi = \frac{N}{M_\chi p(\widetilde{S_1^*}) p(S_2^*)^2}. 
\]
Similar to the prime power conductor case above, we have $|a_{p(\widetilde{S_1^*})}(g_\chi)|  = p(\widetilde{S_1^*})^{k/2 -1/2}$.  So 
\begin{equation} \label{formula: converse}
	|v_\chi^{k} u_\chi^{-2}| = p(\widetilde{S_1^*}) p(S_2^*)^2.
\end{equation}
Hence we can factor $|v_\chi^{k} u_\chi^{-2}|$ and obtain $p(\widetilde{S_1^*})$
and $p(S_2^*)$. Then $M_\chi$ can be solved using $v_\chi$. Plug it back into $u_\chi$, we obtain $a_{p(\widetilde{S_1^*})} w(g_\chi)$. Finally, for each $p \in \widetilde{S_1^*}$,  the $v_\chi p$'s coefficient of 
$t_\chi$ allows us to compute $a_{p(\widetilde{S_1^*})/p}(g_\chi) w(g_\chi)$. These together determines $w(g_\chi)$ and 
$a_{p(\widetilde{S_1^*})}$. The other Fourier coefficients of $g_\chi$ can then be computed recursively. 
\end{proof}




\section{Fields of definitions}

In the previous sections, we have described an algorithm to compute the Fourier coefficients of $f_z$. In fact, the Fourier coefficients are algebraic numbers. More precisely, if 
$c$ is the denominator of  $z$ and $c' = N/c$, then $f_z (q) \in K_f(\zeta_{c'})[[q]]$. Here $K_f$ is the number field generated by the Fourier coefficients of $f$ (at the cusp $\infty$). Although this result is well-known, we include a proof for the reader's convenience.
\begin{Lemma}
Let $c$ be a cusp of denominator $d$ and let $d' = N/d$. Then 
\[
	\bQ(\{a_n(f, c)\}) \subseteq \bQ( \{a_n(f)\}, \zeta_{d'}). 
\]
\end{Lemma}

(fixme: add proof)

%\begin{proof}
%Let $K_0 = \bQ( \{a_n(f)\}$
%Choose a form $0 \neq g \in S_k(\Gamma_1(N))$ with rational Fourier coefficients such that 
%$h = \frac{f}{g}$ is non-constant. From [Cox, ] it is easy to see that $h \in $. Then we have 
%\end{proof}

\section{Denominators}

(fixme)



\section{Examples}

Let $E = {\bf 50a}$ and consider the 4 cusps of denominator 10 on $X_0(50)$. The corresponding first terms 
of $q$-expansions at these cusps are  
\begin{align*}
	a_1(f, \frac{1}{10}) &= \frac{1}{5} \zeta_{5}^{3} - \frac{3}{5} \zeta_{5}^{2} + \frac{3}{5} \zeta_{5} - \frac{1}{5} \\ 
	a_1(f, \frac{3}{10}) &= \frac{3}{5} \zeta_{5}^{3} + \frac{6}{5} \zeta_{5}^{2} + \frac{4}{5} \zeta_{5} + \frac{2}{5} \\
	a_1(f, \frac{7}{10}) &= \frac{2}{5} \zeta_{5}^{3} - \frac{1}{5} \zeta_{5}^{2} - \frac{4}{5} \zeta_{5} - \frac{2}{5}\\
	a_1(f, \frac{9}{10}) &=-\frac{6}{5} \zeta_{5}^{3} - \frac{2}{5} \zeta_{5}^{2} - \frac{3}{5} \zeta_{5} - \frac{4}{5}
\end{align*}

As another examples, let $E = {\bf 98a}$ and $z = [\frac{1}{14}]$. We computed numerically that
\begin{align*}
f_z(q) = \left(-0.755001687308946 - 0.172324208281817i\right)q + \left(0.441471704846525 - 0.916725441095080i\right)q^{2} \\ 
+ \left(1.39294678431094 + 1.11083799261729i\right)q^{3} + \left(0.696473392155471 - 0.555418996308649i\right)q^{4} \\ 
+ \left(1.51000337461789 - 0.344648416563641i\right)q^{6} + \left(-3.80647894157196 \times 10^{-16} - 3.02371578407382i\right)q^{7} \\
+ \left(0.755001687308946 + 0.172324208281817i\right)q^{8} + \left(-0.441471704846525 + 0.916725441095080i\right)q^{9} +  \\ 
\left(-0.882943409693050 - 1.83345088219016i\right)q^{12} + \left(-3.02000674923578 + 0.689296833127282i\right)q^{13} \\
+ \left(3.80647894157196 \times 10^{-16} + 3.02371578407382i\right)q^{14} + O(q^{15})
\end{align*}


\section{Applications}

One applications of the computation done in this chapter is the norm method to the computation of $j$-polynomials 
introduced in Chapter~. Recall that the issue with the norm method for non-square free level is computing the 
expansions of form $f | \gamma$, where $\gamma$ runs over the set of right coset representatives of $\Gamma_0(N)$ 
in $SL_2(\bZ)$. As we have seen, it suffices to compute the expansions of 
$f$ at all width one cusps.
\iffalse
\begin{Lemma}
For any cusp $z$ of $X_0(N)$, there exists an Atkin-Lehner involution $w \in W(N)$ such that $z_1 = w(z)$ has 
width one.
\end{Lemma}

\begin{proof}
Let $z \neq [\infty]$ be a cusp. Recall that $z$ has width one if and only if its denominator $d(z)$ satisfies
$d(z)^2 \equiv 0 \pmod{N}$. Let $p$ be a prime divisor of $N$. Then it is easy to see that 
$v_p(d(w_p(z))) = v_p(N) -  v_p(d(z))$ and $v_l(d(w_p(z))) = v_l(d(z))$ for primes $l \neq p$. The lemma now follows by taking $w = \prod_{p \mid N: v_p(d(z)) \leq v_p(N)/2} w_p$. 
\end{proof}
\fi

\section{Automorphic representations; norm of first terms}

In this section, we will restrict ourselves to the case when the Fourier coefficients of $f$ are rational numbers. Then 
$f$ induces an admissible reprensetation $\pi_f$ of $GL_2(\bA_\bQ)$. We will see that the expansion of $f$ at all cusps can also be computed from the local component $\pi_{f,p}$. Loeffler and Weinstein gave an algorithm to compute such 
local components. 

We will restrict ourselves to the simplest case when $f$ is twist-minimal, which means that the conductor of $\pi_f$ is the smallest among all  twists $\pi_{f \otimes \chi}$. 

We will follow the notations of David Loeffler and use the formula of Francois Brunault. Also, I will use Jacquet-Langlands, 
Gelbart, and Bushnell-Henniart. 

\red{Okay, what is my heuristics for general $k$? What is it for $\Gamma_1(N)$? What happens on the automorphic side?}

\red{Also there's the question about normalization, which was never specified.}

\red{Raw data?}

Let $z$ be a width one cusp of denominator $c$. Then the first coefficient $a_1(f_z)$ is an element in $K_f(\zeta_{c'})$. For simplicity, we assume that $c' = p^{\alpha}$ is a prime power. It can be proved using automorphic representations + local langlands correspondence that there exists $\beta$ such that $p^\beta a_1(f_z) \in \bar{\bZ}$.  One question is: what prime ideals appears in the prime factorisation of $(a_1(f,z))$?  It seems from our numerical data, that
\[
	\ord_\fq(a_1(f_z)) > 0 \implies \fq \cap \bZ \equiv \pm 1 \pmod {p}.
\]
The following is a table of data. 

(fix: add table)

\subsection{Cuspidal local constants}

We keep the assumptions that $f$ is a newform attached to an elliptic curve $E/\bQ$ and $f$ is twist-minimal. Assume 
$p$ is a prime dividing the conductor $N$ of $E$ such that $v_p(N) = 2$. Then there exists a character 
$\varphi: \bF_{p^2}^{\times} \to \bC^{\times}$ which determines $\pi_{f,p}$. We will prove 

\begin{Lemma} \label{cuspidal constant}
Let $\psi: \bQ_p \to \bC^{\times}$ be a character of level one (e.g. $\psi(x) = e(\{\frac{x}{p}\}_p)$). Then
\[
	\epsilon(\pi_{f,p}, 1/2, \psi)  = \frac{-1}{p} \sum_{x \in \bF_{p^2}^{\times}} \psi( x + x^p) \varphi(x). 
\]
If $\chi$ is a Dirichlet character such that the $f\otimes \chi$ has the same level as $f$. Then 
\[
	\epsilon(\pi_{f \otimes \chi,p}, 1/2, \psi)  = \frac{-1}{p} \sum_{x \in \bF_{p^2}^{\times}} \psi( x + x^p) \varphi(x) \bar{\chi}(x^{p+1}). 
\]
\end{Lemma}


\begin{proof}
By [BH], taking $n =  r = 1$, we have 
\begin{equation} 
	p^2 \epsilon(\pi_{f,p}, 1/2, \psi) \cdot \text{id} = \sum_{x \in GL_2(\bF_p)} \psi(tr(x)) \pi_{f,p}^{\vee}(x).
\end{equation}
where $\pi_{f,p}^{\vee}$ denotes the contragredient representation. The representation $\pi_{f,p}$ has dimension $(p-1)$.
Taking traces, we obtain 
\begin{equation} \label{cuspidal const}
	p^2 (p-1) \epsilon(\pi_{f,p}, 1/2, \psi) \cdot \text{id} = \sum_{x \in GL_2(\bF_p)} \psi(tr(x)) Tr(\pi_{f,p}^{\vee}(x)).
\end{equation}
By assumption, $\pi_{f,p}$ arises from a cupsidal representation of the finite group $GL_2(\bF_p)$, which is in turn induced from $\varphi$. (See Fulton-Harris), we have formulae for $Tr(\pi_{f,p}^{\vee}(x))$. Splitting the sum corresponding to four types of conjugacy classes, we computed $S_1 =  (p-1)  \sum_{x \in \bF_p^{\times}} \psi(2x)$, $S_2 = (p^2-1) \sum_{x \in \bF_p^{\times}} \psi(2x) (-1)$, $S_3 = 0$, and $S_4=  (p^2-p)/2 \sum_{x \in \bF_{p^2} \setminus \bF_p} \psi(tr(x))(\overline{\varphi(x) + \varphi(x^p)})$. So the sum on the right hand side of \ref{cuspidal const}  equals $(p-p^2) \sum_{x \in \bF_{p^2}^{\times}} \psi(tr(x)) \overline{\varphi(x)}$. Dividing by $p^2(p-1)$ gives the formula.

\end{proof}

Moreover, since $E$ is defined over $\bQ$, the character of $\pi_{f,p}$ takes rational values. Hence the order of $\varphi$ is 3,4 or 6. 

\begin{Lemma}[See Kraus?]
Let $\Delta$ denote the minimal discriminant of $E$. Then for $p \geq 5$, the order of $\varphi$ is equal to 
$\frac{12}{\gcd(12, v_p(\Delta))}$.
\end{Lemma}

The local Langlands correspondence claims that the order of $\varphi$ is equal to the order of the inertia subgroup 
of $Gal(L/\bQ)$, where $L$ is the smallest number field over which $E$ acquires good reduction \red{(to-do: check this)}.

For $p = 2$ or $3$, the order of $\varphi$ can be determined using Kraus's result \url{http://gdz.sub.uni-goettingen.de/dms/load/img/?PPN=GDZPPN002231468&IDDOC=219018}, or Dokchitser's paper Euler factors determine local Weil representations. 

We remark that for elliptic curves, $v_2(N)$ is at most 8 and $v_3(N)$ is at most 5. For the sake of simplicity, we do not treat the case when $v_p(N) > 2$ here, but we point out the local constants can be  also computed from formula in [BH], 
once the local component is determined using [DW]. 

\begin{Example}
An example with trivial central character.  Let $f$ be the newform attached to $E = \bf{121a}$. Using Sage, we computed $w(f) = -1$. Since the weight of $f$ is 2, we know $\epsilon_\infty = -1$ (since the central character of $\pi_f$ is trivial, the level of the additive character $\psi_\infty$ does not matter). The discriminant of $E$ is $\Delta = -121$, so $\varphi$ has order 6. Using Lemma~\ref{cuspidal constant}, we computed that
$\epsilon_{11}(\pi_{f,11}, 1/2) = -1$. This verifies $w(f) = - \prod_{p \leq \infty} \epsilon_p$. 
\end{Example}

\begin{Example}
We give an example with nontrivial central character. Let $f$ be as in the previous example, and let $\chi$ be the Dirichlet character of $\bF_{11}^{\times}$ defined by $\chi(2) = e^{2\pi i /10}$. Lemma~\ref{cuspidal constant} gives 
\[
	\epsilon_{11}(\pi_{f \otimes \chi,11}, 1/2) = 0.64..+0.76..i
\]
an algebraic number with miminal polynomial $x^{20} + 109/121 x^15 + 2861/1331 x^10 + 109/121x^5 + 1$.
So $w = - \epsilon_{11} \epsilon_\infty = \epsilon_{11}$. Using the numerical algorithm \ref{alg: pseudo-eigenvalue},
we compute $w(f \otimes \chi) = 0.642573377564283 + 0.766224154177894i$. This confirms the computation. 
\end{Example}


\section{Norm of first terms computations}

We keep the assumptions from the previous section, that $f$ is a newform in $S_2(\Gamma_0(N))$, attached to an elliptic curve $E/\bQ$. We assume $f$ is twist-minimal and $p \geq 5$ is a prime dividing the conductor $N$ such that 
$v_p(N) = 2$.  In this case, the cusp $z_p = \left[\frac{-p}{N} \right]$ is of width one, and the $q$-expansion of $f$ at $z_p$
takes an especially simple form.  We summarize this in the lemma below. 
\begin{Lemma}
With the assumptions above, there exists a Galois-invariant set of numbers $\{b_1, \ldots, b_{p-1}\} \subseteq \bQ(\zeta_p)$, such that 
\[
	f_{z_p}(q) = \sum_{n \geq 1} a_n(f) b_{n\mod{p}} q^n. 
\]
More precisely, the $b_j$ are given by 
\[
 b_j = w(f) \sum_{\chi: \cond(\chi) = p} g(\bar{\chi}) w(f\otimes \chi) \chi(n)
\]
\end{Lemma}

\begin{proof}
First, the assumptions imply that $a_{n}(f) =  0$ if $p \mid n$. So the right hand side of the formula is well-defined. 
The formulae then follow directly from Theorem \ref{thm: ExpansionFormula}.   We have $b_j \in \bQ(\zeta_p)$ since the cusp $z_p$ is defined over $\bQ(\zeta_p)$. \red{(fixme: check this)}. Moreover, the cusps $\{z_p^{(j)} = \frac{-jp}{N}: 1 \leq j \leq p-1\}$ form a Galois orbit on $X_0(N)$, and one has 
\[
	a_n(f_{z_p^{(j)}}) = a_{jn}(f_{z_p}), \, \forall n \geq 1, 1 \leq j \leq p-1. 
\]
In particular, we have $\{b_j\} = \{a_1(f_{z_p^{(j)}})\}$. Since the latter set is Galois-invariant, so is the former. 
\end{proof}

We remark that it is clear from the formula of $b_j$ that they are algebraic number. However, the formula does not imply directly that they lie in $\bQ(\zeta_p)$. 

We give another formula of $a_1(f_{z_p})$ in light of the previous section. 

\begin{Lemma} \label{formula: first term}
Keeping the assumptions in the previous two sections, we have 
$$a_1(f_{z_p}) = \frac{\sum_{x \in \bF_{p^2}^{\times}} \psi(x+x^p+x^{p+1}) \varphi(x)}{\sum_{x \in \bF_{p^2}^{\times} }\psi(x+x^p) \varphi(x)}. $$
\end{Lemma}

\begin{Example}
Let $f$ be the newform attached to $E  =\bf{49a}$. One checks that $f$ is twist-minimal and $\varphi$ has order 4. Using Lemma~\ref{formula: first term}, we computed $$a_1(f_{-1/7}) = -\frac{5}{7} \zeta_{7}^{5} - \frac{3}{7} \zeta_{7}^{4} - \frac{1}{7} \zeta_{7}^{3} + \frac{1}{7} \zeta_{7}^{2} + \frac{3}{7} \zeta_{7} - \frac{2}{7} = 0.623489... + 1.29468...i. $$
The numerical algorithm gives $a_1(f_{-1/7}) = 0.623489801858733...+ 1.29468991410431...i$. Hence our formulae are 
consistent for this example.
\end{Example}


It is of interest to determine the factorization of $a_1(f_{z_p})$ as a principal fractional ideal in $\bQ(\zeta_p)$. From the 
above discussion, we see that there are at most three possibilities for each $p$, corresponding to the order of $\varphi$ being 3,4 or 6.


\chapter{Things I tried to do but did not end up giving a nice result}

generalizing the ``congruence number'' definition using other cusps.  

Prove the ``$\pm 1$ mod p'' guess. 

Generalize another paper by William on computing order of component groups. (The original paper uses a trick which 
William fails to remember). 

Prove even index for Chow-Heegner points. 

Computing the critical subgroup for 5077a (multimodular is not practical). 

Critical points of reduction of modular parametrization. 


\nocite{*}
\bibliographystyle{alpha}
\bibliography{uwthesis}


\end{document}
